<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Momentum Travel | Reset Password</title>
    <style>
        body { font-family: -apple-system, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; background: #F8F9FA; margin: 0; }
        .card { background: white; padding: 2.5rem; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 100%; max-width: 400px; text-align: center; }
        h2 { color: #2C3E50; margin-bottom: 8px; }
        p { color: #7F8C8D; font-size: 14px; margin-bottom: 24px; }
        input { width: 100%; padding: 14px; margin: 10px 0; border: 1px solid #EEE; border-radius: 12px; box-sizing: border-box; font-size: 16px; }
        button { background: #3498DB; color: white; border: none; padding: 14px; border-radius: 12px; cursor: pointer; font-weight: bold; width: 100%; font-size: 16px; transition: background 0.3s; }
        button:disabled { background: #BDC3C7; cursor: not-allowed; }
        .status { margin-top: 15px; font-size: 13px; color: #E67E22; font-weight: 500; }
        #success-msg { color: #27AE60; display: none; font-weight: 600; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="card">
        <h2>New Password</h2>
        <p>Set a new password for your Momentum account.</p>
        
        <div id="setup-status" class="status">Connecting to Supabase...</div>
        
        <input type="password" id="new-password" placeholder="Minimum 6 characters" />
        <button id="reset-btn" onclick="updatePassword()" disabled>Update Password</button>
        
        <div id="success-msg">Password updated! You can now return to the app and sign in.</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://iyvdwywgihhgxkbradom.supabase.co'; 
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5dmR3eXdnaWhoZ3hrYnJhZG9tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3ODUxMTUsImV4cCI6MjA4NTM2MTExNX0.6hkOAOQvDVczhZlxKZ6rp5cwk-85mLvNVPQFnmOZUIk';
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey, {
            auth: { detectSessionInUrl: true, persistSession: false }
        });

        // The "Session Watcher": Keeps checking until the token is caught
        let checkCount = 0;
        const checkSession = setInterval(async () => {
            const { data } = await supabase.auth.getSession();
            const statusDiv = document.getElementById('setup-status');
            const btn = document.getElementById('reset-btn');

            if (data?.session) {
                statusDiv.innerText = "Ready to reset!";
                statusDiv.style.color = "#27AE60";
                btn.disabled = false; // ENABLE THE BUTTON
                clearInterval(checkSession);
            } else if (checkCount > 10) { // If it takes more than 5 seconds
                statusDiv.innerText = "Link expired or invalid. Try again from the app.";
                statusDiv.style.color = "#E74C3C";
                clearInterval(checkSession);
            }
            checkCount++;
        }, 500);

        async function updatePassword() {
            const password = document.getElementById('new-password').value;
            const btn = document.getElementById('reset-btn');
            const statusDiv = document.getElementById('setup-status');
            const successMsg = document.getElementById('success-msg');

            if (password.length < 6) return alert("Password must be at least 6 characters.");

            btn.disabled = true;
            btn.innerText = "Saving...";

            const { error } = await supabase.auth.updateUser({ password: password });

            if (error) {
                alert("Error: " + error.message);
                btn.disabled = false;
                btn.innerText = "Update Password";
            } else {
                // Success UI swap
                document.getElementById('new-password').style.display = "none";
                btn.style.display = "none";
                statusDiv.style.display = "none";
                successMsg.style.display = "block";
                
                // Clear session and sign out
                await supabase.auth.signOut();
            }
        }
    </script>
</body>
</html>
